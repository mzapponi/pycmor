# Dockerfile for pycmor testing environment
# Uses micromamba for compatible HDF5/NetCDF/netcdf4-python stack

ARG PYTHON_VERSION=3.11
FROM mambaorg/micromamba:1.5.10

USER root

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    git-lfs \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory and give ownership to MAMBA_USER
WORKDIR /workspace
RUN chown -R $MAMBA_USER:$MAMBA_USER /workspace && \
    chmod -R 755 /workspace

# Switch to micromamba user for conda operations
USER $MAMBA_USER

# Install Python and scientific stack via micromamba (ensures compatibility)
# This installs matching HDF5/NetCDF/netcdf4-python versions
ARG PYTHON_VERSION
RUN micromamba install -y -n base -c conda-forge \
    python=${PYTHON_VERSION} \
    hdf5 \
    netcdf4 \
    h5netcdf \
    h5py \
    pip \
    && micromamba clean --all --yes

# Activate the base environment for subsequent commands
ARG MAMBA_DOCKERFILE_ACTIVATE=1

# Copy project files
COPY --chown=$MAMBA_USER:$MAMBA_USER pyproject.toml versioneer.py ./
COPY --chown=$MAMBA_USER:$MAMBA_USER src/pycmor/_version.py src/pycmor/_version.py
COPY --chown=$MAMBA_USER:$MAMBA_USER . .

# Install pycmor and dev dependencies via pip (uses conda's Python/libs)
RUN pip install --no-cache-dir ".[dev,fesom,cmip7]"

# Pre-generate CMIP7 variable metadata for doctests (v1.2.2.2)
# Uses -a (all opportunities) and -m (variables metadata output)
# The -m file contains "Compound Name" structure used by load_metadata()
RUN mkdir -p /home/$MAMBA_USER/.cache/pycmor/cmip7_metadata && \
    export_dreq_lists_json -a v1.2.2.2 \
        /tmp/experiments.json \
        -m /home/$MAMBA_USER/.cache/pycmor/cmip7_metadata/v1.2.2.2.json && \
    rm /tmp/experiments.json

# Set environment variables for testing
ENV PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300
ENV PYTHONUNBUFFERED=1
ENV HDF5_USE_FILE_LOCKING=FALSE
ENV PYCMOR_CMIP7_METADATA_DIR=/home/mambauser/.cache/pycmor/cmip7_metadata

# Verify installation
RUN python -c "import h5py; print('h5py version:', h5py.__version__); print('HDF5 version:', h5py.version.hdf5_version)" && \
    python -c "import netCDF4; print('netCDF4 version:', netCDF4.__version__)"

# Default command runs tests
CMD ["pytest", "-vvv", "--cov=src/pycmor", "tests/"]
