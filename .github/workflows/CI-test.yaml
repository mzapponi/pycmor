# For more information see: https://tinyurl.com/mr4y7r8n
name: Run Basic Tests
on:
  push:
    branches: ["main", "prep-release"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main", "prep-release"]
  workflow_dispatch:
    inputs:
      build_arm64:
        description: 'Build ARM64 images (slow, for M1/M2/M3 Mac support)'
        required: false
        type: boolean
        default: false
jobs:
  # Setup job for linting and formatting checks
  lint_and_format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install black flake8 pytest isort yamllint
      - name: Lint with flake8 (syntax errors only)
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=CMIP7-CVs,CMIP7_DReq_Software,cmip6-cmor-tables
      - name: Run full flake8 check
        run: |
          # stop at any error
          flake8 . --show-source --statistics --exclude=CMIP7-CVs,CMIP7_DReq_Software,cmip6-cmor-tables
      - name: Run isort
        run: |
          isort --check . --skip CMIP7-CVs --skip CMIP7_DReq_Software --skip cmip6-cmor-tables
      - name: Run black
        run: |
          black --check . --exclude='(CMIP7-CVs|CMIP7_DReq_Software|cmip6-cmor-tables)'
      - name: Run yamllint
        run: |
          yamllint .

  # Build jobs - one per Python version
  build-3-9:
    name: Build Test Image Python 3.9
    needs: [lint_and_format]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get short SHA and sanitize branch name
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=$(echo '${{ github.head_ref || github.ref_name }}' | sed 's/\//_/g')" >> $GITHUB_OUTPUT
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          platforms: ${{ github.event.inputs.build_arm64 == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
          tags: |
            ghcr.io/esm-tools/pycmor-testground:py3.9-${{ steps.vars.outputs.sha_short }}
            ghcr.io/esm-tools/pycmor-testground:py3.9-${{ steps.vars.outputs.branch_name }}
          build-args: |
            PYTHON_VERSION=3.9
          cache-from: type=gha,scope=py3.9
          cache-to: type=gha,mode=max,scope=py3.9

  build-3-10:
    name: Build Test Image Python 3.10
    needs: [lint_and_format]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get short SHA and sanitize branch name
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=$(echo '${{ github.head_ref || github.ref_name }}' | sed 's/\//_/g')" >> $GITHUB_OUTPUT
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          platforms: ${{ github.event.inputs.build_arm64 == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
          tags: |
            ghcr.io/esm-tools/pycmor-testground:py3.10-${{ steps.vars.outputs.sha_short }}
            ghcr.io/esm-tools/pycmor-testground:py3.10-${{ steps.vars.outputs.branch_name }}
          build-args: |
            PYTHON_VERSION=3.10
          cache-from: type=gha,scope=py3.10
          cache-to: type=gha,mode=max,scope=py3.10

  build-3-11:
    name: Build Test Image Python 3.11
    needs: [lint_and_format]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get short SHA and sanitize branch name
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=$(echo '${{ github.head_ref || github.ref_name }}' | sed 's/\//_/g')" >> $GITHUB_OUTPUT
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          platforms: ${{ github.event.inputs.build_arm64 == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
          tags: |
            ghcr.io/esm-tools/pycmor-testground:py3.11-${{ steps.vars.outputs.sha_short }}
            ghcr.io/esm-tools/pycmor-testground:py3.11-${{ steps.vars.outputs.branch_name }}
          build-args: |
            PYTHON_VERSION=3.11
          cache-from: type=gha,scope=py3.11
          cache-to: type=gha,mode=max,scope=py3.11

  build-3-12:
    name: Build Test Image Python 3.12
    needs: [lint_and_format]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Get short SHA and sanitize branch name
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
          echo "branch_name=$(echo '${{ github.head_ref || github.ref_name }}' | sed 's/\//_/g')" >> $GITHUB_OUTPUT
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          platforms: ${{ github.event.inputs.build_arm64 == 'true' && 'linux/amd64,linux/arm64' || 'linux/amd64' }}
          tags: |
            ghcr.io/esm-tools/pycmor-testground:py3.12-${{ steps.vars.outputs.sha_short }}
            ghcr.io/esm-tools/pycmor-testground:py3.12-${{ steps.vars.outputs.branch_name }}
          build-args: |
            PYTHON_VERSION=3.12
          cache-from: type=gha,scope=py3.12
          cache-to: type=gha,mode=max,scope=py3.12

  # Meta test jobs - one per Python version
  test-meta-3-9:
    name: Meta Test Python 3.9
    needs: [build-3-9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test if data will work (Meta-Test) and generate coverage
        run: |
          docker run --rm \
            -e HDF5_DEBUG=1 \
            -e NETCDF_DEBUG=1 \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/meta/**.py && python -m coverage xml -o /workspace/coverage-meta-3.9.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-meta-3.9
          path: coverage-meta-3.9.xml

  test-meta-3-10:
    name: Meta Test Python 3.10
    needs: [build-3-10]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test if data will work (Meta-Test) and generate coverage
        run: |
          docker run --rm \
            -e HDF5_DEBUG=1 \
            -e NETCDF_DEBUG=1 \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/meta/**.py && python -m coverage xml -o /workspace/coverage-meta-3.10.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-meta-3.10
          path: coverage-meta-3.10.xml

  test-meta-3-11:
    name: Meta Test Python 3.11
    needs: [build-3-11]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test if data will work (Meta-Test) and generate coverage
        run: |
          docker run --rm \
            -e HDF5_DEBUG=1 \
            -e NETCDF_DEBUG=1 \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/meta/**.py && python -m coverage xml -o /workspace/coverage-meta-3.11.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-meta-3.11
          path: coverage-meta-3.11.xml

  test-meta-3-12:
    name: Meta Test Python 3.12
    needs: [build-3-12]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test if data will work (Meta-Test) and generate coverage
        run: |
          docker run --rm \
            -e HDF5_DEBUG=1 \
            -e NETCDF_DEBUG=1 \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/meta/**.py && python -m coverage xml -o /workspace/coverage-meta-3.12.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-meta-3.12
          path: coverage-meta-3.12.xml

  # Unit test jobs - one per Python version
  test-unit-3-9:
    name: Unit Test Python 3.9
    needs: [test-meta-3-9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Unit) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/unit/**.py && python -m coverage xml -o /workspace/coverage-unit-3.9.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-unit-3.9
          path: coverage-unit-3.9.xml

  test-unit-3-10:
    name: Unit Test Python 3.10
    needs: [test-meta-3-10]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Unit) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/unit/**.py && python -m coverage xml -o /workspace/coverage-unit-3.10.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-unit-3.10
          path: coverage-unit-3.10.xml

  test-unit-3-11:
    name: Unit Test Python 3.11
    needs: [test-meta-3-11]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Unit) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/unit/**.py && python -m coverage xml -o /workspace/coverage-unit-3.11.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-unit-3.11
          path: coverage-unit-3.11.xml

  test-unit-3-12:
    name: Unit Test Python 3.12
    needs: [test-meta-3-12]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Unit) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/unit/**.py && python -m coverage xml -o /workspace/coverage-unit-3.12.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-unit-3.12
          path: coverage-unit-3.12.xml

  # Integration test jobs - one per Python version
  test-integration-3-9:
    name: Integration Test Python 3.9
    needs: [test-meta-3-9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Integration) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/integration/**.py && python -m coverage xml -o /workspace/coverage-integration-3.9.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-integration-3.9
          path: coverage-integration-3.9.xml

  test-integration-3-10:
    name: Integration Test Python 3.10
    needs: [test-meta-3-10]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Integration) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/integration/**.py && python -m coverage xml -o /workspace/coverage-integration-3.10.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-integration-3.10
          path: coverage-integration-3.10.xml

  test-integration-3-11:
    name: Integration Test Python 3.11
    needs: [test-meta-3-11]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Integration) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/integration/**.py && python -m coverage xml -o /workspace/coverage-integration-3.11.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-integration-3.11
          path: coverage-integration-3.11.xml

  test-integration-3-12:
    name: Integration Test Python 3.12
    needs: [test-meta-3-12]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with pytest (Integration) and generate coverage
        run: |
          docker run --rm \
            -e PYCMOR_USE_REAL_TEST_DATA=1 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_ENGINE=netcdf4 \
            -e PYCMOR_XARRAY_OPEN_MFDATASET_PARALLEL=no \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "pytest -vvv -s --cov=src/pycmor tests/integration/**.py && python -m coverage xml -o /workspace/coverage-integration-3.12.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-integration-3.12
          path: coverage-integration-3.12.xml

  # Doctest jobs - one per Python version
  test-doctest-3-9:
    name: Doctest Python 3.9
    needs: [test-meta-3-9]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with doctest and generate coverage
        run: |
          docker run --rm \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.9-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "PYTHONPATH=src PYTHONLOGLEVEL=CRITICAL pytest -v --doctest-modules --cov=src/pycmor src/ && python -m coverage xml -o /workspace/coverage-doctest-3.9.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-doctest-3.9
          path: coverage-doctest-3.9.xml

  test-doctest-3-10:
    name: Doctest Python 3.10
    needs: [test-meta-3-10]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with doctest and generate coverage
        run: |
          docker run --rm \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.10-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "PYTHONPATH=src PYTHONLOGLEVEL=CRITICAL pytest -v --doctest-modules --cov=src/pycmor src/ && python -m coverage xml -o /workspace/coverage-doctest-3.10.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-doctest-3.10
          path: coverage-doctest-3.10.xml

  test-doctest-3-11:
    name: Doctest Python 3.11
    needs: [test-meta-3-11]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with doctest and generate coverage
        run: |
          docker run --rm \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.11-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "PYTHONPATH=src PYTHONLOGLEVEL=CRITICAL pytest -v --doctest-modules --cov=src/pycmor src/ && python -m coverage xml -o /workspace/coverage-doctest-3.11.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-doctest-3.11
          path: coverage-doctest-3.11.xml

  test-doctest-3-12:
    name: Doctest Python 3.12
    needs: [test-meta-3-12]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache test data
        uses: actions/cache@v4
        with:
          path: ~/.cache/pycmor/test_data
          key: pycmor-test-data-v1
          restore-keys: |
            pycmor-test-data-
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull Docker image from GHCR
        run: |
          docker pull ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g")
      - name: Create persistent cache directory
        run: |
          mkdir -p ~/.cache/pycmor/test_data
      - name: Test with doctest and generate coverage
        run: |
          docker run --rm \
            -e PREFECT_SERVER_EPHEMERAL_STARTUP_TIMEOUT_SECONDS=300 \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.cache/pycmor:/home/mambauser/.cache/pycmor \
            --user root \
            ghcr.io/esm-tools/pycmor-testground:py3.12-$(echo "${{ github.head_ref || github.ref_name }}" | sed "s#/#_#g") \
            bash -c "PYTHONPATH=src PYTHONLOGLEVEL=CRITICAL pytest -v --doctest-modules --cov=src/pycmor src/ && python -m coverage xml -o /workspace/coverage-doctest-3.12.xml"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-doctest-3.12
          path: coverage-doctest-3.12.xml

  # Status and output jobs
  post-status:
    name: Post Status for other jobs
    needs: [lint_and_format, test-unit-3-9, test-unit-3-10, test-unit-3-11, test-unit-3-12, test-integration-3-9, test-integration-3-10, test-integration-3-11, test-integration-3-12, test-doctest-3-9, test-doctest-3-10, test-doctest-3-11, test-doctest-3-12]
    runs-on: ubuntu-latest
    steps:
      - name: Set output for lint and test status
        id: set-output
        run: |
          echo "::set-output name=test_status::success"
          echo "::set-output name=lint_status::success"
          echo "lint_status=success" >> $GITHUB_ENV
          echo "test_status=success" >> $GITHUB_ENV
          echo "lint_status=success" >> $GITHUB_OUTPUT
          echo "test_status=success" >> $GITHUB_OUTPUT

  set-output:
    name: Set Output for Ref
    runs-on: ubuntu-latest
    needs: [lint_and_format, test-unit-3-9, test-unit-3-10, test-unit-3-11, test-unit-3-12, test-integration-3-9, test-integration-3-10, test-integration-3-11, test-integration-3-12, test-doctest-3-9, test-doctest-3-10, test-doctest-3-11, test-doctest-3-12]
    outputs:
      ref: ${{ steps.set-ref.outputs.ref }}
      is_tag: ${{ steps.set-ref.outputs.is_tag }}
    steps:
      - name: Determine if Ref is a Tag
        id: set-ref
        run: |
          echo "ref=${GITHUB_REF}" >> $GITHUB_OUTPUT
          if [[ "${GITHUB_REF}" =~ ^refs/tags/ ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi
          echo "cat ${GITHUB_OUTPUT}"
          cat $GITHUB_OUTPUT

  set-workflow-artifact:
    name: Set workflow artifact
    runs-on: ubuntu-latest
    needs: set-output
    steps:
      - name: Create artifact
        run: |
          echo "Creating artifact..."
          echo "ref=$REF"
          echo "is_tag=$IS_TAG"
          echo "ref=$REF" >> status.dat
          echo "is_tag=$IS_TAG" >> status.dat
        env:
          REF: ${{ needs.set-output.outputs.ref }}
          IS_TAG: ${{ needs.set-output.outputs.is_tag }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ github.run_id }}
          path: status.dat

  # Combined test coverage report
  coverage:
    name: Generate Coverage Report
    needs: [test-meta-3-9, test-meta-3-10, test-meta-3-11, test-meta-3-12, test-unit-3-9, test-unit-3-10, test-unit-3-11, test-unit-3-12, test-integration-3-9, test-integration-3-10, test-integration-3-11, test-integration-3-12, test-doctest-3-9, test-doctest-3-10, test-doctest-3-11, test-doctest-3-12]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-cov coverage
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
      - name: Process coverage reports
        run: |
          # Create directories for each Python version and test type
          mkdir -p coverage-output/3.9 coverage-output/3.10 coverage-output/3.11 coverage-output/3.12
          # Copy coverage reports to their respective directories
          for version in 3.9 3.10 3.11 3.12; do
            # Combine all coverage reports for each version
            for type in meta unit integration doctest; do
              if [ -f "coverage-reports/coverage-reports-${type}-${version}/coverage-${type}-${version}.xml" ]; then
                cp coverage-reports/coverage-reports-${type}-${version}/coverage-${type}-${version}.xml coverage-output/${version}/coverage-${type}.xml
              fi
            done
          done
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          directory: ./coverage-output/
          fail_ci_if_error: false
          flags: python-3.9,python-3.10,python-3.11,python-3.12
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: esm-tools/pycmor
